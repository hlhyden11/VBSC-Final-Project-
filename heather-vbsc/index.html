<!DOCTYPE html>
<html>

<head>
    <title>Final Project</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

    <script src='https://api.mapbox.com/mapbox.js/v2.2.4/mapbox.js'></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
    <script src='https://code.jquery.com/jquery-1.12.0.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/0.9.0/simple_statistics.min.js'></script>


    <link href='https://api.mapbox.com/mapbox.js/v2.2.4/mapbox.css' rel='stylesheet' />
    <link href='https://fonts.googleapis.com/css?family=Work+Sans:400,500,600' rel='stylesheet' type='text/css'>


    <style>
        html,
        body,
        #map {
            height: 100%;
            padding: 0;
            margin: 0;
        }

        #map {
            width: 80%;
        }

        #controls {
            width: 20%;
            position: absolute;
            right: 0;
            background: whitesmoke;
            top: 0;
            bottom: 0;
            padding: 15px;
        }
        .legend {
            padding: 6px 8px;
            font-size: 1em;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .legend h3 {
            font-size: 1.1em;
            font-weight: normal;
            color: #001323;
            margin: 0 0 10px 0;
        }
        .legend span {
            width: 20px;
            height: 20px;
            float: left;
            margin: 0 10px 4px 0;
        }
        .legend label {
            font-size: 1.1em;
        }
        .legend label:after {
            content: '';
            display: block;
            clear: both;
        }
        .leaflet-right .leaflet-control {
            margin-right: 40px;
        }
    </style>
</head>

<body>

    <div id="map"></div>
    <div id="controls">
        <h2>VBSC Type</h2>

        <div id="types">
            <label><input type="checkbox" value="cooperativ" checked>Cooperative</label>
            <br>
            <label><input type="checkbox" value="csa" checked>CSA</label>
            <br>
            <label><input type="checkbox" value="food_hub" checked>Food Hub</label>
            <br>
            <label><input type="checkbox" value="online_de" checked>Online Delivery</label>
        </div>

        <h2>Products Available</h2>

        <div id="products">
            <label><input type="checkbox" value="eggs" checked>eggs</label>
            <br>
            <label><input type="checkbox" value="meat" checked>meat</label>
            <br>
            <label><input type="checkbox" value="dairy" checked>dairy</label>
        </div>
    </div>

<script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>
<script>
    var options = {
        center: [37.8, -85.8],
        zoom: 4,
        zoomControl: true
    }
    var map = L.map('map', options);

    var vbscs, states;  // global variables to reference

    var removedLayers = L.layerGroup();


    var tiles = L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    $.getJSON('https://hlhyden1.cartodb.com/api/v2/sql?format=GeoJSON&q=SELECT * FROM sites', function (data) {

        $.getJSON('https://hlhyden1.cartodb.com/api/v2/sql?format=GeoJSON&q=SELECT * FROM state_kml', function (statesData) {

            drawMap(data, statesData);

        });

    });
    
    function getColor(count, breaks) {
        
        if(count == null) {
            return 'gray';
        }
        
        if(count === 0) {
            return 'blue';
        }
        
        return count <= breaks[1] ? "#ffffb2" :
               count <= breaks[2] ? "#fecc5c" :
               count <= breaks[3] ? "#fd8d3c" :
               count <= breaks[4] ? "#f03b20" :
                           "#bd0026"
  
    }
    
    function drawLegend(breaks) {
        
        var legend = L.control({position: 'bottomright'});

        legend.onAdd = function () {

            var div = L.DomUtil.create('div', 'legend');

            div.innerHTML = "<h3>VBSCs per State</h3>";
            
            div.innerHTML +='<span style="background: blue"></span> ' +
                   '<label>zero</label>';

   
             // for each of our breaks
            for (var i = 1; i < breaks.length; i++) {
                // determine the color associated with each break value,
                // including the lower range value
          
                var color = getColor(breaks[i], breaks);

                // concatenate a <span> tag styled with the color and the range values
                // of that class and include a label with the low and a high ends of that class range
                div.innerHTML +=
                   '<span style="background:' + color + '"></span> ' +
                   '<label>'+(breaks[i-1]) + ' &mdash; ' + 
                    (breaks[i]) + '</label>';
            }

            return div;

        };

    legend.addTo(map);
        
        
        
    }
    
    function getBreaks(statesData) {
        
        var dataRange = [];
        statesData.features.forEach(function(state) {
            
//            var val = state.properties.count/state.properties.farmers
            var val = state.properties.count/50;
            
            dataRange.push(val)
        })
        
        
        var breaks = ss.jenks(dataRange,5);
        
        return breaks;
        
    }
    
    function drawMap(data, statesData) { //not sure how to access

        var breaks = getBreaks(statesData);
       
        states = L.geoJson(statesData, {
            
            style : function(feature) {
                
                return {
                    
                    color: 'white',
                    weight: 3,
                    fillOpacity: 1,
                    //fillColor: getColor(feature.properties.count)  
                    fillColor: getColor(feature.properties.count/50, breaks)  
                    
                }
  
            }
            
        }).addTo(map);
        
        drawLegend(breaks);

         vbscs = L.geoJson(data, {
              pointToLayer : function (properties, latlng) {
                 return L.circleMarker(latlng, {
                     opacity: 1,
                     weight: 2,
                     fillOpacity: 1,
                     radius: 4,
                     stroke: false,
                     fillColor: 'green'
        
                 });
             },
             onEachFeature: function(feature, layer) {

                  var popup = feature.properties.business_n;
                  layer.bindPopup(popup);


                }
         }).addTo(map);

        
        addUI();

    }

    function addUI() {
        
        
         var sourcesLayers = {
            "VBSCs": vbscs,
            "State Count": states
        }
        
        L.control.layers(null, sourcesLayers, { collapsed:false }).addTo(map);
        
        var currentChecked = [];

//         $('input').on('change', function () {
//                var val = $(this).val();
//       
//                if (this.checked) {
//                    currentChecked.push(val);
//                    filterSelection(currentChecked);
//                } else {
//                    var i = currentChecked.indexOf(val);
//                    if (val != 1) {
//                        currentChecked.splice(i, 1);
//                    }
//                    filterSelection(currentChecked);
//                }
//            });

    } // end addUI


   function filterSelection(vals) {
       console.log(vals)
        // first add any layers from the removed layers
        // and clear the removedLayers
        removedLayers.eachLayer(function (layer) {
            vbscs.addLayer(layer);
            removedLayers.removeLayer(layer);
        });
        // then loop through our currently displayed properties
        // add them to the removedLayers group and remove from map
        for (var i = 0; i < vals.length; i++) {
            vbscs.eachLayer(function (layer) {
                if (layer.feature.properties[vals[i]] == false) {
                    removedLayers.addLayer(layer);
                    vbscs.removeLayer(layer);
                }
            });
        }
    }



    </script>
</body>

</html>
