<!DOCTYPE html>
<html>

<head>
    <title>Final Project</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

    <script src='https://api.mapbox.com/mapbox.js/v2.2.4/mapbox.js'></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
    <script src='https://code.jquery.com/jquery-1.12.0.min.js'></script>


    <link href='https://api.mapbox.com/mapbox.js/v2.2.4/mapbox.css' rel='stylesheet' />
    <link href='https://fonts.googleapis.com/css?family=Work+Sans:400,500,600' rel='stylesheet' type='text/css'>


    <style>
        html,
        body,
        #map {
            height: 100%;
            padding: 0;
            margin: 0;
        }
        
        #map {
            width: 60%;
        }
        
        #controls {
            width: 40%;
            position: absolute;
            right: 0;
            background: whitesmoke;
            top: 0;
            bottom: 0;
            padding: 15px;
        }
    </style>
</head>

<body>

    <div id="map"></div>
    <div id="controls">
        <h2>VBSC Type</h2>

        <div id="types">
            <label>
                <input type="checkbox" value="cooperativ" checked>Cooperative</label>
            <br>
            <label>
                <input type="checkbox" value="csa" checked>CSA</label>
            <br>
            <label>
                <input type="checkbox" value="food_hub" checked>Food Hub</label>
            <br>
            <label>
                <input type="checkbox" value="online_de" checked>Online Delivery</label>
        </div>

        <h2>Products Available</h2>

        <div id="products">
            <label>
                <input type="checkbox" value="eggs" checked>eggs</label>
            <br>
            <label>
                <input type="checkbox" value="meat" checked>meat</label>
            <br>
            <label>
                <input type="checkbox" value="dairy" checked>dairy</label>
        </div>
    </div>

    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>

    <!--<script type="cartocss/html" id="state_kml">
        #state_kml{ polygon-fill: #FFFFCC; polygon-opacity: 0.8; line-color: #FFF; line-width: 0.5; line-opacity: 1; } #state_kml [ column_1465323954858
        <=2 1] { polygon-fill: #0C2C84; } #state_kml [ column_1465323954858 <=1 6] { polygon-fill: #225EA8; } #state_kml [ column_1465323954858 <=1 3] { polygon-fill: #1D91C0; } #state_kml [ column_1465323954858 <=1 0] { polygon-fill: #41B6C4; } #state_kml [ column_1465323954858 <=7 ] { polygon-fill: #7FCDBB; } #state_kml [ column_1465323954858 <=4 ] { polygon-fill: #C7E9B4; } #state_kml [ column_1465323954858 <=2 ] { polygon-fill: #FFFFCC; } </script>-->

    <script>
        var options = {
            center: [37.8, -85.8],
            zoom: 4,
            zoomControl: true
        }
        var map = L.map('map', options);

        var vbscs, states; // global variables to reference 

        var removedLayers = L.layerGroup();

        var currentTypes = ['csa', 'online_de', 'food_hub', 'cooperativ'];

        var currentProducts = ['eggs', 'meat', 'dairy'];
        var tiles = L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        $.getJSON('https://hlhyden1.cartodb.com/api/v2/sql?format=GeoJSON&q=SELECT * FROM sites', function (data) {


            $.getJSON('https://hlhyden1.cartodb.com/api/v2/sql?format=GeoJSON&q=SELECT * FROM state_kml', function (statesData) {


                drawMap(data, statesData);

            });
        });

        function drawMap(data, statesData) { //not sure how to access


            vbscs = L.geoJson(data, {
                pointToLayer: function (properties, latlng) {
                    return L.circleMarker(latlng, {
                        opacity: 1,
                        weight: 2, //Need to add size for each
                        fillOpacity: 1,
                        radius: 4,
                        stroke: false
                    });
                },
                style: function (feature) {

                    for (var prop in feature.properties) { //can we add another loop for size styling? 

                        if (prop === 'csa' && feature.properties['csa'] === "1") {
                            return {
                                color: '#D96D02'
                            };
                        } else if (prop === 'online_de' && feature.properties['online_de'] === "1") {
                            return {
                                color: 'green'
                            };
                        } else if (prop === 'food_hub' && feature.properties['food_hub'] === "1") {
                            return {
                                color: 'blue'
                            };
                        } else if (prop === 'cooperativ' && feature.properties['cooperativ'] === "1") {
                            return {
                                color: 'orange'
                            };
                        }

                    }

                }
            }).addTo(map);

            addUI();

            function drawStates(states) {
                dataLayer = L.geoJson(states, {

                    // initially set polygon border and fill properties
                    style: function (feature) {
                            return {
                                color: '#A9A9A9',
                                weight: 1,
                                fillOpacity: 1,
                                fillColor: '#1f78b4'
                            }
                        }
                        // add polygons to the map    
                }).addTo(map).bringToBack();
                // fires the function to update the map for user functionality
                updateMap();
            }

            function updateMap() {

                var breaks = getClassBreaks();

                dataLayer.eachLayer(function (layer) {
                    layer.setStyle({
                        color: '#A9A9A9',
                        weight: 1,
                        fillColor: getColor(layer.feature.properties.count, breaks),
                        fillOpacity: 1,
                    });

                    var props = layer.feature.properties;
                });
                updateLegend(breaks);
            }

            /*function updateLegend(breaks) {

                var legend = $('.legend').html("<h3>State VBSC Count: " + (Number(density)) + "</h3><ul>");

                for (var i = 0; i < breaks.length - 1; i++) {

                    var color = getColor(breaks[i + 1], breaks);

                    $('.legend ul').append('<li><span style="background:' + color + '"></span> ' + breaks[i] + ' &mdash; ' + breaks[i + 1] + '</li>');
                }

                legend.append("</ul>");
            }*/

            function getClassBreaks() {

                var values = [];

                dataLayer.eachLayer(function (layer) {
                    var value = layer.feature.properties.count;

                    values.push(value);
                });

                var clusters = ss.ckmeans(values, 5);

                var breaks = clusters.map(function (cluster) {
                    return [cluster[0], cluster.pop()];
                });

                return breaks;
            }

            function getColor(d, breaks) {

                if (d <= breaks[0][1]) {
                    return '#ca641c';
                } else if (d <= breaks[1][1]) {
                    return '#9d4e15';
                } else if (d <= breaks[2][1]) {
                    return '#874312';
                } else if (d <= breaks[3][1]) {
                    return '#5a2d0c'
                } else if (d <= breaks[4][1]) {
                    return '#2d1606'
                }
            }


            function addUI() {

                $('#types input').change(function () {
                    var val = $(this).val();
                    if (this.checked) {
                        currentTypes.push(val);
                        filterSelection('type');
                    } else {
                        var i = currentTypes.indexOf(val);
                        if (val != 1) {
                            currentTypes.splice(i, 1);
                        }
                        filterSelection('type');
                    }
                });

                $('#products input').change(function () {
                    var val = $(this).val();

                    if (this.checked) {
                        currentProducts.push(val);
                        filterSelection('product');
                    } else {
                        var i = currentChecked.indexOf(val);
                        if (val != 1) {
                            currentProducts.splice(i, 1);
                            filterSelection('product');
                        }
                    }
                });

            } // end addUI
            function filterSelection(cat) {

                if (cat == 'type') {

                    vbscs.eachLayer(function (layer) {
                        removedLayers.addLayer(layer);
                        vbscs.removeLayer(layer);
                    })
                    removedLayers.eachLayer(function (layer) {
                        currentTypes.forEach(function (type) {
                            if (layer.feature.properties[type] == true) {
                                vbscs.addLayer(layer);
                                removedLayers.removeLayer(layer);
                            }
                        })
                    });

                }

                if (cat == 'product') {

                    // filter the prouducts here

                }

            }
    </script>
</body>

</html>